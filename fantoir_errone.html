<html>
<head>
<meta charset="UTF-8">
<title>Codes Fantoir erronés</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/tablesorter/jquery.tablesorter.js"></script>
<script src="js/jquery.tablesorter.combined.min.js"></script>
<script src="js/fonctions.js"></script>
<link rel="preload" href="css/fonts/opensans-latin.woff2" as="font" type="font/woff2" crossorigin>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/responsive.css" type="text/css"/>

<script>
    var titre = "Codes Fantoir erronés"
    function start(){
        document.title = titre
        numero_dept = check_url_for_dept()
        if (numero_dept){
            $('#input_dept').empty()
            $('#input_dept')[0].value = numero_dept
            requete_fantoir_errone_dept();
        }
    }
    function requete_fantoir_errone_dept(){
        if (check_form_for_dept()){
            numero_dept = $('#input_dept')[0].value
            document.title = titre+' ('+numero_dept+')'

            $('body').css('cursor','progress');
            $('#wait_ajax').empty()
                            .css('visibility','visible')
                            .append($('<p>').append('Chargement des codes Fantoir erronés...'))
            $.ajax({
                url: "fantoir_errone.py?dept="+numero_dept,
            })
            .done(function( data ){
                nom_dept = data[0][0][1]
                code_dept = data[0][0][0]

                data = data[1]
                titre_bandeau = ' codes Fantoir erronés'
                if (data.length < 2){
                    titre_bandeau = ' code Fantoir erroné'
                }
                $('#bandeau h1').empty().append(data.length+titre_bandeau)
                $('#bandeau h2').empty().append(nom_dept+' ('+numero_dept+')')

                $('#wait_ajax').css('visibility','hidden');

                url_map_org_part1 = 'http://www.openstreetmap.org/'
                delta = 0.0008

                $('#table_fantoir_errone').trigger("destroy");
                $('#table_fantoir_errone').empty()

                $('#table_fantoir_errone').append($('<thead>').append($('<tr>').append($('<th>').append('Dept'))))
                $('#table_fantoir_errone tr').append($('<th>').append('Commune (code Insee)'))
                $('#table_fantoir_errone tr').append($('<th>').append('Code Fantoir erroné'))
                $('#table_fantoir_errone tr').append($('<th>').append('Voie OSM'))
                $('#table_fantoir_errone tr').append($('<th>').attr('colspan','1').append('Carte'))
                $('#table_fantoir_errone tr').append($('<th>').attr('colspan','1').append('Édition'))
                $('#table_fantoir_errone tr').append($('<th>').attr('colspan','2').append('Voir la commune sur...'))

                $('#table_fantoir_errone').append($('<tbody>'))
                for (l=0;l<data.length;l++){
                    let [fantoir,
                        nom,
                        lon,
                        lat,
                        dept,
                        commune] = data[l]
                    insee = fantoir.substr(0,5)

                    //Dept
                    $('#table_fantoir_errone').append($('<tr>').attr('id',fantoir).append($('<td>').text(dept)))
                    //Commune (INSEE)
                    $('#table_fantoir_errone tr:last').append($('<td>').text(commune+' ('+insee+')'))
                    //Code Fantoir
                    $('#table_fantoir_errone tr:last').append($('<td>').addClass('cell_mauvais_fantoir').text(fantoir))
                    //Nom OSM
                    $('#table_fantoir_errone tr:last').append($('<td>').text(nom))
                    url_hash_coords = '18/'+lat+'/'+lon
                    xleft   = lon-delta
                    xright  = lon+delta
                    ybottom = lat-delta
                    ytop    = lat+delta
                    //visu
                    add_map_link('table_fantoir_errone',url_map_org_part1+'#map='+url_hash_coords,'ORG')
                    //JOSM
                    add_josm_link('table_fantoir_errone',xleft,xright,ybottom,ytop,insee,commune)
                    //Fantoir
                    add_map_link('table_fantoir_errone','./index.html?insee='+insee,'Pifomètre ('+insee+')')
                    add_map_link('table_fantoir_errone','./liste_brute_fantoir.html?insee='+insee,'Topo brut ('+insee+')')
                }

                //Sticky headers : le tableau scrolle dans son contenant
                $('#table_fantoir_errone').tablesorter({
                    widthFixed : true,
                    headerTemplate : '{content} {icon}', // Add icon for various themes
                    widgets: [ 'stickyHeaders', 'filter' ],
                    widgetOptions: {
                      stickyHeaders_attachTo : '#reponse'
                    }
                });
                window.location.hash="#dept="+code_dept
                $('body').css('cursor','default');
            })
        }
    };
</script>
</head>
<body onload="start()">

    <header>
        <!--#include file="includes/menu.html" -->
    </header>

    <div id="barre-jaune">
        <span>Département :</span>
        <form action="javascript:requete_fantoir_errone_dept()" autocomplete="on">
            <input type="text" id="input_dept" placeholder="N° de département"></input>
            <input type="submit" value="Afficher">
        </form>
    </div>

    <div id="bandeau">
        <div id="descriptif">
            <h2></h2>
            <h1>Codes Fantoir erronés</h1>
            <h3>Liste des codes Fantoir trouvés dans OSM et inconnus du fichier Topo (ex Fantoir) officiel. Ce sont souvent des codes erronés, à cause d'erreurs de frappe : minuscules, inversions de caratères, etc.</h3>
        </div>
        <div id="wait_ajax" class="bas"></div>
    </div>

    <div id="reponse" class="haut">
        <table id="table_fantoir_errone" class="tablesorter"></table>
    </div>

    <footer>
        <!--#include file="includes/footer.html" -->
    </footer>

    <div id="josm_target" style="visibility : hidden"></div>

</body>
</html>