<html>
<head>
<meta charset="UTF-8">
<title>Adresses OSM sans rue</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/tablesorter/jquery.tablesorter.js"></script>
<script src="js/jquery.tablesorter.combined.min.js"></script>
<script src="js/fonctions.js"></script>
<link rel="preload" href="css/fonts/opensans-latin.woff2" as="font" type="font/woff2" crossorigin>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/responsive.css" type="text/css"/>

<script>
    var table = 'table_adresses_osm_sans_rue'

    var titre = "Adresses OSM sans rue"

    function is_valid_dept(d){
        pattern_dept = new RegExp('^([01]|[3-8])([0-9])$|^2([aAbB]|[1-9])$|^9([0-5]|7[1-4]|76)$')
        res = false
        if (pattern_dept.test(d)){
            res = d
        }
        return res
    }
    function start(){
        document.title = titre
        dept = check_url_for_dept()
        if (dept){
            $('#input_dept').empty()
            $('#input_dept')[0].value = dept
            requete_voies_dept();
        }

    }

    function update_csv_url(dept){
       urlCSV = 'adresses_osm_sans_rue.py?dept='+dept+'&format=csv';
    }

    function requete_voies_dept(){
        if (check_form_for_dept()){
            dept = $('#input_dept')[0].value
            document.title = titre+' ('+dept+')'

            update_csv_url(dept)

            $('body').css('cursor','progress');
            $('#wait_ajax').empty()
                            .css('visibility','visible')
                            .append($('<p>').append('Recherche des adresses OSM sans rue ni lieu-dit...'));

            let [a_menus_labels,STATUS_FANTOIR] = get_labels_statut_fantoir()

            $.ajax({
                url: "adresses_osm_sans_rue.py?dept="+dept,
            })
            .done(function( data ){
                $('body').css('cursor','default');
                $('#'+table).empty()
                if (data[0].length == 0){
                    $('#bandeau h1').empty().append('dept '+$('#input_dept')[0].value+' : département inconnu')
                    $('body').css('cursor','default');
                    $('#wait_ajax').css('visibility','hidden');
                    return 0;
                }
                numero_dept = data[0][0][0]
                nom_dept = data[0][0][1]
                data = data[1]
                if (data.length == 1){
                    titre_bandeau = 'unique adresse OSM sans rue ou lieu-dit'
                } else {
                    titre_bandeau = data.length+' adresses OSM sans rue ou lieu-dit' 
                }
                $('#bandeau h2').empty().append(nom_dept+' ('+numero_dept+')')
                $('#bandeau h1').empty().append(titre_bandeau)

                url_map_org_part1 = 'http://www.openstreetmap.org/'
                url_map_fr_part1 = 'http://tile.openstreetmap.fr/'
                url_bano_part1 = 'http://tile.openstreetmap.fr/~cquest/leaflet/bano.html'
                url_edit_part1 = 'http://www.openstreetmap.org/edit?editor='
                delta = 0.0008

                $('#'+table).empty().append($('<thead>').append($('<tr>').append($('<th>').append('Dept'))))
                $('#'+table+' tr').append($('<th>').append('Commune (Insee)'))
                $('#'+table+' tr').append($('<th>').append('Code Fantoir'))
                $('#'+table+' tr').append($('<th>').append("Nom de l'adresse"))
                $('#'+table+' tr').append($('<th>').attr('colspan','1').append('Carte'))
                $('#'+table+' tr').append($('<th>').attr('colspan','1').append('Édition'))
                $('#'+table+' tr').append($('<th>').append('Statut du nom ').append($('<a>').attr('href','http://wiki.openstreetmap.org/wiki/Contribuer_%C3%A0_la_BANO#Typologie_des_anomalies_FANTOIR').append('(wiki)')))
                $('#'+table+' tr').append($('<th>').attr('colspan','2').append('Voir la commune sur...'))

                $('#'+table).append($('<tbody>'))

                for (l=0;l<data.length;l++){
                    let [dept,
                         insee,
                         nom_commune,
                         nom_voie,
                         fantoir,
                         lon,
                         lat,
                         caractere_annul,
                         statut_fantoir] = data[l]
                    fantoir_affiche = fantoir
                    if (caractere_annul == 'B'){
                        fantoir_affiche = 'Voie sans Fantoir'
                    }

                    //Dept
                    $('#'+table).append($('<tr>').attr('id',l).append($('<td>').text(dept)))
                    //Commune (INSEE)
                    $('#'+table+' tr:last').append($('<td>').text(nom_commune+' ('+insee+')'))
                    //Code Fantoir
                    $('#'+table+' tr:last').append($('<td>').addClass('cell_fantoir').text(fantoir_affiche))
                    //Voie
                    $('#'+table+' tr:last').append($('<td>').text(nom_voie))
                    url_marker = '?mlat='+lat+'&mlon='+lon
                    url_hash_coords = '18/'+lat+'/'+lon
                    xleft   = lon-delta
                    xright  = lon+delta
                    ybottom = lat-delta
                    ytop    = lat+delta
                    //visu
                    add_map_link(table,url_map_org_part1+url_marker+'#map='+url_hash_coords,'ORG')
                    //JOSM
                    add_josm_link(table,xleft,xright,ybottom,ytop,insee,nom_commune)
                    //Statut Fantoir
                    if (caractere_annul != 'B'){
                        add_statut_fantoir('table_adresses_osm_sans_rue',l,fantoir,statut_fantoir)
                    } else {
                        $('#'+table+' tr:last').addClass('statut0').append($('<td>'))
                    }
                    //Liens Pifo et Fantoir
                    add_map_link(table,'./index.html?insee='+insee,'Pifomètre ('+insee+')')
                    add_map_link(table,'./liste_brute_fantoir.html?insee='+insee,'Topo brut ('+insee+')')
                }
                $('#wait_ajax').css('visibility','hidden');

                //Sticky headers : le tableau scrolle dans son contenant
                $('#'+table).tablesorter({
                    widthFixed : true,
                    headerTemplate : '{content} {icon}', // Add icon for various themes
                    widgets: [ 'stickyHeaders', 'filter' ],
                    widgetOptions: {
                      stickyHeaders_attachTo : '#reponse'
                    }
                });
            })
            window.location.hash="#dept="+$('#input_dept')[0].value
        };
    }
</script>
</head>
<body onload="start()">

    <header>
        <!--#include file="includes/menu.html" -->
    </header>

    <div id="barre-jaune">
        <span>Département :</span>
        <form action="javascript:requete_voies_dept()" autocomplete="on">
            <input type="text" id="input_dept" placeholder="N° de département"></input>
            <input type="submit" value="Afficher">
        </form>
    </div>
    <div id="bandeau">
        <div id="descriptif">
            <h2></h2>
            <h1>Adresses trouvées dans OSM sans voie ou lieu-dit</h1>
            <h3>Le nom de ces adresses (<span class="monospace">addr:street</span>, <span class="monospace">addr:place</span> ou <span class="monospace">name</span> dans une relation <span class="monospace">associatedStreet</span>) est introuvable ailleurs dans OSM. C'est le signe qu'il manque ce nom sur une rue, un lieu-dit, une place, un parking, etc.</h3>
        </div>
        <button id="bouton_export_csv" title="Exporter la liste courante en CSV" onclick="window.open(urlCSV, '_blank');"></button>
        <div id="wait_ajax" class="bas"></div>
    </div>

    <div id="reponse">
        <table id="table_adresses_osm_sans_rue" class="avec_statuts tablesorter"></table>
    </div>

    <footer>
    <!--#include file="includes/footer.html" -->
    </footer>

    <div id="josm_target" style="visibility : hidden"></div>
</body>
</html>