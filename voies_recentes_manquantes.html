<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Voies récentes inconnues d'OSM</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/tablesorter/jquery.tablesorter.js"></script>
<script src="js/jquery.tablesorter.combined.min.js"></script>
<script src="js/fonctions.js"></script>
<link rel="preload" href="css/fonts/opensans-latin.woff2" as="font" type="font/woff2" crossorigin>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/responsive.css" type="text/css"/>

<script>
    var menu_labels
    var table = 'table_voies_recentes'
    var titre = "Voies inconnues d'OSM"
    var nb_lignes_par_page = 250

    function start(){
        document.title = titre
        let [a_menus_labels,STATUS_FANTOIR] = get_labels_statut_fantoir()
        dept = check_url_for_dept()
        if (dept){
            $('#input_dept').empty()
            $('#input_dept')[0].value = dept
            requete_voies_dept();
        }
    }

    function update_csv_url(dept){
       urlCSV = 'voies_recentes_manquantes_dept.py?dept='+dept+'&format=csv&offset='+offset+'&limit='+nb_lignes_par_page;
    }

    function requete_voies_dept(){
        if (check_form_for_dept()){
            numero_dept = $('#input_dept')[0].value
            document.title = titre+' ('+numero_dept+')'
            offset = check_url_for_offset()

            update_csv_url(numero_dept)

            $('body').css('cursor','progress');
            $('#wait_ajax').empty()
                            .css('visibility','visible')
                            .append($('<p>').append('Recherche des voies manquantes...'));
            $.ajax({
                url: "voies_recentes_manquantes_dept.py?dept="+numero_dept+'&offset='+offset+'&limit='+nb_lignes_par_page,
            })
            .done(function( data ){
                $('body').css('cursor','default');
                // numero_dept = data[0][0][0]
                nom_dept = data[0][1]
                nb_lignes_total = data[0][2]

                if (nb_lignes_total == 1){
                    titre_bandeau = " unique voie connue de la BAN ou de Fantoir<br/>mais pas d'OSM"
                } else {
                    titre_bandeau = nb_lignes_total+" voies connues de la BAN ou du fichier Topo mais pas d'OSM,<br/>classées par date"
                }

                $('#bandeau h2').empty().append(nom_dept+' ('+numero_dept+')')
                $('#bandeau h1').empty().append(titre_bandeau)

                $('#'+table).empty()
                $('.pagination').empty()

                url_map_org_part1 = 'http://www.openstreetmap.org/'
                url_map_fr_part1 = 'http://tile.openstreetmap.fr/'
                url_bano_part1 = 'http://tile.openstreetmap.fr/~cquest/leaflet/bano.html'
                url_edit_part1 = 'http://www.openstreetmap.org/edit?editor='
                delta = 0.0008

                $('#'+table).empty().append($('<thead>').append($('<tr>').append($('<th>').append('Commune (Insee)'))))
                $('#'+table+' tr').append($('<th>').append('Code Fantoir'))
                $('#'+table+' tr').append($('<th>').append('Voie'))
                $('#'+table+' tr').append($('<th>').append('Date de création'))
                $('#'+table+' tr').append($('<th>').attr('colspan','1').append('Carte'))
                $('#'+table+' tr').append($('<th>').attr('colspan','2').append('Édition'))
                $('#'+table+' tr').append($('<th>').append('Statut du nom ').append($('<a>').attr('href','http://wiki.openstreetmap.org/wiki/Contribuer_%C3%A0_la_BANO#Typologie_des_anomalies_FANTOIR').append('(wiki)')))
                $('#'+table+' tr').append($('<th>').attr('colspan','3').append('Voir la commune sur...'))
                $('#'+table).append($('<tbody>'))

                data = data[1]
                for (l=0;l<data.length;l++){
                    let [insee,
                        nom_com,
                        voie,
                        fantoir,
                        lon,
                        lat,
                        date_creation,
                        id_statut] = data[l]

                    fantoir_affiche = fantoir
                    fantoir_dans_relation = 'ok'
                    has_fantoir = true
                    if (fantoir[5] == 'b'){
                        fantoir_affiche = 'Voie sans FANTOIR'
                        fantoir_dans_relation = 'ko'
                        has_fantoir = false
                    }

                    url_marker = '?mlat='+lat+'&mlon='+lon
                    url_hash_coords = '18/'+lat+'/'+lon
                    xleft   = lon-delta
                    xright  = lon+delta
                    ybottom = lat-delta
                    ytop    = lat+delta

                    $('#'+table).append($('<tr>').attr('id',l).addClass('statut'+id_statut).append($('<td>').text(nom_com+' ('+insee+')')))
                    //Commune (INSEE)
                    // $('#'+table+' tr:last').append($('<td>').text(nom_com+' ('+insee+')'))
                    //Code Fantoir
                    $('#'+table+' tr:last').append($('<td>').addClass('cell_fantoir').text(fantoir))
                    //Voie
                    $('#'+table+' tr:last').append($('<td>').text(voie))
                    //Date de création
                    $('#'+table+' tr:last').append($('<td>').text(date_creation))

                    //visu
                    add_map_link(table,url_map_org_part1+url_marker+'#map='+url_hash_coords,'ORG')
                    //JOSM
                    add_josm_link(table,xleft,xright,ybottom,ytop,insee,nom_com)
                    //--- iD ---
                    add_id_link(table,'http://www.openstreetmap.org/edit?editor=id#map=18/'+lat+'/'+lon,'ID')
                    // Statut
                    if (has_fantoir){
                        add_statut_fantoir(table,l,fantoir,id_statut)
                    } else {
                        $('#'+table+' tr:last').addClass('statut_vide').append($('<td>'))
                    }
                    //Liens Pifo et Fantoir
                    add_map_link(table,'./index.html?insee='+insee,'Pifomètre')
                    add_map_link(table,'./pifomap.html?insee='+insee+'#map='+url_hash_coords,'Pifomap')
                    add_map_link(table,'./liste_brute_fantoir.html?insee='+insee,'Topo')
                }
                $('#wait_ajax').css('visibility','hidden');

                //Sticky headers : le tableau scrolle dans son contenant
                $('#'+table).tablesorter({
                    widthFixed : true,
                    headerTemplate : '{content} {icon}', // Add icon for various themes
                    widgets: [ 'stickyHeaders', 'filter' ],
                    widgetOptions: {
                      stickyHeaders_attachTo : '#reponse'
                    }
                });

                //---PAGINATION---
                $('.pagination').append($('<p>').text('Pages :'))
                
                //Première page
                if (offset>0) {
                    $('.pagination').append($('<a title="Première page" href="'+window.location.pathname+"?dept="+numero_dept+'&offset=0"><div id="prem">&laquo;</div></a>'))
                }
                //Page précédente
                if (offset>0) {
                    $('.pagination').append($('<a title="Page précédente" href="'+window.location.pathname+"?dept="+numero_dept+'&offset='+(parseFloat(offset)-nb_lignes_par_page)+'"><div>&lsaquo;</div></a>'))
                }
                //Page active
                $('.pagination').append($('<div>'+(offset/nb_lignes_par_page+1)+'</div>').addClass('active'))
                //Page suivante
                if (nb_lignes_total-offset>nb_lignes_par_page) {
                    $('.pagination').append($('<a title="Page suivante" href="'+window.location.pathname+"?dept="+numero_dept+'&offset='+(parseFloat(offset)+nb_lignes_par_page)+'"><div>&rsaquo;</div></a>'))
                }
                //Dernière page
                if (nb_lignes_total-offset>nb_lignes_par_page) {
                    $('.pagination').append($('<a title="Dernière page" href="'+window.location.pathname+"?dept="+numero_dept+'&offset='+nb_lignes_par_page*Math.floor(nb_lignes_total/nb_lignes_par_page)+'"><div id="dern">&raquo;</div></a>'))
                }

            })//fin fonction done

            history.replaceState("", "", window.location.pathname+"?dept="+numero_dept+'&offset='+offset);

        };
    }
</script>
</head>
<body onload="start()">
    <header>
        <!--#include file="includes/menu.html" -->
    </header>
    <div id="barre-jaune">
        <span>Département :</span>
        <form action="javascript:requete_voies_dept()" autocomplete="on">
            <input type="text" id="input_dept" placeholder="N° de département"/>
            <input type="submit" value="Afficher"/>
        </form>
    </div>
    <div id="bandeau">
        <div id="descriptif">
            <h2></h2>
            <h1>Voies connues de la BAN ou du fichier Topo mais pas d'OSM,<br/>classées par date</h1>
        </div>
        <button id="bouton_export_csv" title="Exporter la liste courante en CSV" onclick="window.open(urlCSV, '_blank');"></button>
        <div id="wait_ajax" class="bas"></div>
        <div class="pagination"></div>
    </div>
    <div id="reponse">
        <table id="table_voies_recentes" class="tablesorter avec_statuts"></table>
    </div>
    <footer>
    <!--#include file="includes/footer.html" -->
    </footer>
    <div id="josm_target" style="visibility : hidden"></div>
</body>
</html>