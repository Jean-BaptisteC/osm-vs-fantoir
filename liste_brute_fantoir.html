<html>
<head>
<meta charset="UTF-8">
<title>Listes TOPO par commune</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/tablesorter/jquery.tablesorter.js"></script>
<script src="js/jquery.tablesorter.combined.min.js"></script>
<script src="js/fonctions.js"></script>
<link rel="preload" href="css/fonts/opensans-latin.woff2" as="font" type="font/woff2" crossorigin>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/responsive.css" type="text/css"/>

<script>
	a_champs_fantoir = ['Rapproché ?','Dept','Code Insee','Code Fantoir','Nature voie','Libellé voie','Caractère voie','Car. annul.','Date annul.','Date de création','Type de voie','Mot classant']
	// function check_url_for_insee(){
	// 	pattern_insee = new RegExp('^[0-9][0-9abAB][0-9]{3}$')
	// 	var res
	// 	if (window.location.hash){
	// 		if (window.location.hash.split('insee=')[1]){
	// 			if (pattern_insee.test(window.location.hash.split('insee=')[1].split('&')[0])){
	// 				res = window.location.hash.split('insee=')[1].split('&')[0]
	// 			} else {
	// 				alert(window.location.hash.split('insee=')[1].split('&')[0]+' n\'est pas un code INSEE de commune\n\nAbandon')
	// 			}
	// 		}
	// 	}
	// 	return res
	// }
	function start(){
		insee = check_url_for_insee()
		if (insee){
			$('#input_insee').empty()
			$('#input_insee')[0].value = insee
			listing_fantoir()
		}
	}
	function listing_fantoir(){
		$('body').css('cursor','progress');
		$('#input_insee')[0].value = $('#input_insee')[0].value.toUpperCase()
		$.ajax({
			url: "listing_fantoir.py?insee="+$('#input_insee')[0].value
		})
		.done(function( data ) {
			nom_commune = data[0][0]
			insee = $('#input_insee')[0].value

			$('#infos_commune_col1').empty();
			$('#listing_fantoir').trigger("destroy");
			$('#listing_fantoir').empty().append($('<thead>').append($('<tr>')))

			//Code Insee invalide
			if (nom_commune.length == 0){
				$('#descriptif h2').text('INSEE '+$('#input_insee')[0].value+' : commune inconnue');
				$('body').css('cursor','default');
				return 0;
			}

			document.title = nom_commune+' - Liste TOPO'

      url_map_org_part1 = 'http://www.openstreetmap.org/'
      url_listing_fantoir = './liste_brute_fantoir.html?insee='+$('#input_insee')[0].value

      $('#infos_commune_col1').empty()
      												.append($('<div id="date-maj">')
                                  .append($('<div>').addClass('cellule_intitule').append('<strong>Code Insee :</strong>'))
                                  .append($('<div>').addClass('cellule_data').append('&nbsp;').append(insee))
                              )
                              .append($('<div id="liens_commune">').append('<strong>Voir la commune sur :</strong> ')
                                  /*.append($('<a>')
                                      .attr('target','blank')
                                      .attr('href',url_map_org_part1+'?mlat='+lat_commune+'&mlon='+lon_commune+'#map='+url_hash_coords)
                                      .text('ORG')
                                  )
                                  .append(' / ')*/
                                  .append($('<a>')
                                      .attr('target','blank')
                                      .attr('href','https://adresse.data.gouv.fr/base-adresse-nationale/'+insee)
                                      .text('BAN')
                                  )
                                  /*.append(' / ')
                                  .append($('<a>')
                                      .attr('target','blank')
                                      .attr('href',url_bano_part1+'#'+url_hash_coords)
                                      .text('BANO')
                                  )*/
                                  .append(' / ')
                                  .append($('<a>')
                                      .attr('target','blank')
                                      .attr('href','index.html?insee='+insee)
                                      .text('Pifomètre')
                                  )
                              )
                          
      $('#infos_commune_col2 h2').empty().append(nom_commune)
      $('#infos_commune_col2 h1').empty().append('Fichier Topo brut')

			fantoir = data[1]

			for (c=0;c<a_champs_fantoir.length;c++){
				$('#listing_fantoir > thead > tr:last').append($('<th>').append(a_champs_fantoir[c]))
			}
			$('#listing_fantoir').append($('<tbody>'))
			for (c=0;c<fantoir.length;c++){
				$('#listing_fantoir').append($('<tr>'))
				for (d=0;d<fantoir[c].length;d++){
					$('tr:last').append($('<td>').attr('title',a_champs_fantoir[d]).append($('<span>').append(fantoir[c][d])))
				}

				if ($('tr:last td span')[0].childNodes[0].data == 'OUI'){
					$($('tr:last td')[0]).append($('<span>').addClass('pastille-verte')).addClass('rapproche')
				}
				else if ($('tr:last td span')[0].childNodes[0].data == 'NON') {
					$($('tr:last td')[0]).append($('<span>').addClass('pastille-orange'))
				}
				else if ($('tr:last td span')[0].childNodes[0].data == 'QUALIFIÉ'){
					$($('tr:last td')[0]).append($('<span>').addClass('pastille-grise')).addClass('qualifie')
				}
			}

      //Sticky headers : le tableau scrolle dans son contenant
      $('#listing_fantoir').tablesorter({
          widthFixed : true,
          headerTemplate : '{content} {icon}', // Add icon for various themes
          widgets: [ 'stickyHeaders', 'filter' ],
          widgetOptions: {
            stickyHeaders_attachTo : '#reponse'
          }
      });

		})
    history.replaceState("", "", window.location.pathname+"?insee="+$('#input_insee')[0].value)
		$('body').css('cursor','default');
	}
</script>
</head>
<body onload="start()">
	<header>
		<!--#include file="includes/menu.html" -->
	</header>

	<div id="barre-jaune">
		<span>Commune :</span>
		<form action="javascript:listing_fantoir()" autocomplete="on">
			<input type="text" id="input_insee" placeholder="Code INSEE"></input>
			<input type="submit" value="Lister">
		</form>
	</div>

	<div id="bandeau">
		<div id="descriptif">
			<div id="infos_commune_col1"></div>
			<div id="infos_commune_col2" class="topo_brut">
				<h2></h2>
				<h1></h1>
			</div>
		</div>
	</div>

	<div id="reponse" class="haut">
		<table id="listing_fantoir" class="tablesorter">
		</table>
	</div>

	<footer>
	 <!--#include file="includes/footer.html" -->
	</footer>
</body>
</html>
