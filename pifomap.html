<html>
<head>
<meta charset="UTF-8">
<title>Pifomètre</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/jquery.tablesorter.combined.min.js"></script>
<script src="js/fonctions.js"></script>
<link rel='stylesheet' href='https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.css' />
<script src='https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.js'></script>
<link rel="preload" href="css/fonts/opensans-latin.woff2" as="font" type="font/woff2" crossorigin>
<link rel="stylesheet" href="css/bulma/bulma.min.css" type="text/css"/>
<link rel="stylesheet" href="css/bulma/main.min.css" type="text/css"/>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/responsive.css" type="text/css"/>
<link rel="search" type="application/opensearchdescription+xml" title="Pifomètre BANO" href="opensearch.xml" />
<style type="text/css">
    #map {
        height: 100%;
        width: 100%;
    }
</style>
<script>
    FILTRES = [["voie",true],
               ["lieu_dit",true],
               ["osm_hors_fantoir",true],
               ["nom_integre",true],
               ["nom_a_integrer",true],
               ["avec_adresses",true],
               ["sans_adresses",true]]

    DELTA = 0.0008

    EMPTY_GEOJSON = {'type': 'FeatureCollection',
                          'features': []}

    var table = 'table_pifometre'

    function start(){
        $('#bouton_legende').click(function(){
            $('#legende').css('visibility','visible');
        })
        $('#legende > .fermer').click(function(){
            $('#legende').css('visibility','hidden');
        })

        //-------------------------------------------
        //-------   SWITCH CARTE INTEGRATION   ------
        //-------------------------------------------

        $('#table_communes_voisines').css('visibility','hidden');
        $('#table_communes_voisines table tr td').empty()
                                                 .removeAttr('insee_cible')
                                                 .unbind('click');


        let [a_menus_labels,STATUS_FANTOIR] = get_labels_statut_fantoir()

        insee = check_url_for_insee()
        if (insee){
            $('#input_insee').empty()
            $('#input_insee')[0].value = insee
            requete_pifometre()
        } else {
            map = new maplibregl.Map({
                container: 'map_div',
                style:'./pifomap.style',
                center: [4,46],
                hash: 'map',
                zoom: 5
            });
            map.on('load', () => {
                map_setup()
            });
        }

        $('#bouton_communes_voisines').click(function(){
            $('#table_communes_voisines').css('visibility','visible');
        })
        $('#table_communes_voisines > .fermer').click(function(){
            $('#table_communes_voisines').css('visibility','hidden');
        })

        $('#bouton_refresh').click(function(event){
                                refresh();
                                event.stopPropagation();
                            })
                            .mouseover(function(event){
                                get_osm_state();
                                refresh_infobulle();
                                event.stopPropagation();
                            })
                            .mouseout(function(){
                                $('#refresh_infobulle').hide()
                            })
    };
    function refresh(){
        if (commune_valide == false){
            return 0;
        }
        $('body').css('cursor','progress');
        $('#wait_ajax').empty()
                       .css('visibility','visible') 
                       .append($('<span>').append('Mise à jour BANO en cours...'));
        $.ajax({
            url: "refresh.py?insee="+$('#input_insee')[0].value,
        })
        .done(function( data ){
            if (data == '1'){
                requete_pifometre();
            } else {
                alert('Problème lors de la mise à jour')
            }
            $('body').css('cursor','default');
            $('#wait_ajax').css('visibility','hidden');
        })
    }
    function get_geojson_poly(geom,props){
        return ({'type': 'Feature',
                        'properties': props,
                        'geometry': geom})
    }
    function get_geojson_point(lon,lat,props){
        return ({'type': 'Feature',
                        'properties': props,
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [lon,lat]
                        }})
    }
    function rendu_bano(insee,nom_commune){
        min_lon = 180
        max_lon = -180
        min_lat = 90
        max_lat = -90
        $('#wait_ajax').empty()
                       .css('visibility','visible') 
                       .append($('<span>').append('Chargement...'));
        $.ajax({
            url: "rendu_bano_commune.py?insee="+insee,
        })
        .done(function( data ){
            let [polycommunedata,
                filairedata,
                polydata,
                pointdata,
                pointnommedata] = data

            res = JSON.parse(JSON.stringify(EMPTY_GEOJSON))
            bbox = polycommunedata[0][0].coordinates
            for (s=1;s<polycommunedata.length;s++){
                let [poly] = polycommunedata[s]
                if (poly.type == 'Polygon'){
                    res.features.push(get_geojson_poly(poly,{}))
                }
            }
            map.getSource('contour_communal').setData(res)

            res = JSON.parse(JSON.stringify(EMPTY_GEOJSON))
            for (s=0;s<filairedata.length;s++){
                let [nom,
                    within,
                    geom] = filairedata[s]
                if (geom.type == 'LineString'||geom.type == 'MultiLineString'){
                    res.features.push(get_geojson_poly(geom,{'nom':nom,'within':within}))
                }/* else {
                    console.log(nom,geom)
                }*/

            }
            map.getSource('hover_filaire').setData(res)

            res = JSON.parse(JSON.stringify(EMPTY_GEOJSON))
            for (s=0;s<polydata.length;s++){
                let [fantoir,
                    nom_ban,
                    label_statut,
                    poly] = polydata[s]
                if (poly.type == 'Polygon'){
                    res.features.push(get_geojson_poly(poly,{'fantoir':get_fantoir_affiche(fantoir),'nom':nom_ban,'statut':label_statut}))
                } 
            }
            map.getSource('polygones_convexhull').setData(res)

            res = JSON.parse(JSON.stringify(EMPTY_GEOJSON))
            for (s=0;s<pointnommedata.length;s++){
                 [nom,
                  fantoir,
                  source,
                  lon,
                  lat,
                  rapproche] = pointnommedata[s]
                  res.features.push(get_geojson_point(lon,lat,{'nom':nom,'source':source,'rapproche':rapproche,'fantoir':fantoir,'nom_com':nom_commune}))
            }
            map.getSource('points_nommes').setData(res)

            res = JSON.parse(JSON.stringify(EMPTY_GEOJSON))
            for (s=0;s<pointdata.length;s++){
                 [nom,
                  fantoir,
                  numero,
                  lon_ban,
                  lat_ban,
                  statut,
                  lon_osm,
                  lat_osm,
                  rapproche] = pointdata[s]
                if (lon_osm){
                    min_lon = Math.min(min_lon,lon_osm);
                    max_lon = Math.max(max_lon,lon_osm);
                    min_lat = Math.min(min_lat,lat_osm);
                    max_lat = Math.max(max_lat,lat_osm);
                    res.features.push(get_geojson_point(lon_osm,lat_osm,{'nom':nom,'fantoir':fantoir,'numero':numero,'source':'OSM','rapproche':rapproche,'osm_seul':(lon_ban?false:true),'nom_com':nom_commune}))
                } else {
                    min_lon = Math.min(min_lon,lon_ban);
                    max_lon = Math.max(max_lon,lon_ban);
                    min_lat = Math.min(min_lat,lat_ban);
                    max_lat = Math.max(max_lat,lat_ban);
                    res.features.push(get_geojson_point(lon_ban,lat_ban,{'nom':nom,'fantoir':fantoir,'numero':numero,'source':'BAN','rapproche':rapproche,'nom_com':nom_commune}))
                }
            }
            map.getSource('adresses').setData(res)
            map.getSource('hover').setData(res)

            $('body').css('cursor','default');
            $('#wait_ajax').css('visibility','hidden');
        })
    }
    function requete_pifometre(){
        commune_valide = false;
        $('body').css('cursor','progress');
        // $('#'+table).trigger("destroy");
        // $('#'+table).empty()
        $('#input_insee')[0].value = $('#input_insee')[0].value.toUpperCase()
        $.ajax({
            url: "requete_pifometre_commune.py?insee="+$('#input_insee')[0].value
        })
        .done(function( pifodata ) {
            let [nom_commune,
                 lon_commune,
                 lat_commune,
                 communes_voisines,
                 insee_commune_parente,
                 nom_commune_parente,
                 date_dernier_rapprochement,
                 commune_composee,
                 bbox_diagonale] = pifodata

            let [mapz,mapx,mapy] = check_url_for_xyz()

            premier_affichage = false
            if (mapz < 0){
                mapz = 15
                mapx = lon_commune
                mapy = lat_commune
                premier_affichage = true
            }

            if (typeof map != 'undefined'){
                empty_layers()
            } else {
                map = new maplibregl.Map({
                    container: 'map_div',
                    style:'./pifomap.style',
                    center: [mapx,mapy],
                    hash: 'map',
                    zoom: mapz
                });
                map.on('load', () => {
                    map_setup()
                });
            }
            if (premier_affichage){
                map.fitBounds(bbox_diagonale.coordinates)
            }

            document.title = nom_commune+' - Pifomap'
            $('#descriptif').empty()
            $('#alerte_commune').css('visibility','hidden');

            if (nom_commune.length == 0){
                $('#descriptif').append($('<div id="titre_commune_inconnue">').append($('<h1>').append('Code Insee '+$('#input_insee')[0].value+' : commune inconnue')))
                $('body').css('cursor','default');
                return 0;
            }
            commune_valide = true;
            code_insee = $('#input_insee')[0].value
            update_csv_url()
            $('#wait_ajax').empty()
                           .css('visibility','visible')
                           .append($('<span>').append('Chargement des données...'));


            url_map_org_part1 = 'http://www.openstreetmap.org/'
            url_bano_part1 = 'http://tile.openstreetmap.fr/~cquest/leaflet/bano.html'
            url_edit_part1 = 'http://www.openstreetmap.org/edit?editor='
            delta = 0.0008
            url_hash_coords = '15/'+lat_commune+'/'+lon_commune
            url_listing_fantoir = './liste_brute_fantoir.html?insee='+$('#input_insee')[0].value

            $('#descriptif').append($('<div id="infos_commune_col1">')
                                    .append($('<div id="date-maj">')
                                        .append($('<div>').addClass('cellule_intitule').append('<strong>Dernier rapprochement le</strong>'))
                                        .append($('<div>').addClass('cellule_data').append('&nbsp;').append(date_dernier_rapprochement).append(' (UTC)<br/>'))
                                    )
                                    .append($('<div id="liens_commune">').append('<strong>Voir la commune sur :</strong> ')
                                        .append($('<a>')
                                            .attr('target','blank')
                                            .attr('href',url_map_org_part1+'?mlat='+lat_commune+'&mlon='+lon_commune+'#map='+url_hash_coords)
                                            .text('ORG')
                                        ))
            )
            if (!insee_commune_parente){
                     $('#liens_commune').append(' / ')
                                        .append($('<a>')
                                            .attr('target','blank')
                                            .attr('href','https://adresse.data.gouv.fr/base-adresse-nationale/'+$('#input_insee')[0].value)
                                            .text('BAN')
                                        )
            }
            $('#liens_commune').append(' / ')
                               .append($('<a>')
                                   .attr('target','blank')
                                   .attr('href',url_bano_part1+'#'+url_hash_coords)
                                   .text('BANO')
                               )
                               .append(' / ')
                               .append($('<a>')
                                   .attr('target','blank')
                                   .attr('href',url_listing_fantoir)
                                   .text('Topo (ex-Fantoir)')
                               )
                               .append(' / ')
                               .append($('<a>')
                                   .attr('target','blank')
                                   .attr('href','index.html?insee='+code_insee)
                                   .text('Pifomètre')
                               )

            $('#descriptif').append($('<div id="infos_commune_col2">').append($('<h1>').append((nom_commune))))

            //------------------------------------
            //-------   COMMUNES VOISINES   ------
            //------------------------------------

            $('#table_communes_voisines tr td').empty()
            $('#table_communes_voisines tr td.commune_centre').text(nom_commune)
            for (v in communes_voisines){
                $('#table_communes_voisines tr td#'+(communes_voisines[v])[0]).append($('<a>')
                                                                              .addClass('lien_commune')
                                                                                  .attr('href',window.location.href.split('?')[0]+'?insee='+communes_voisines[v][1])
                                                                                  .text(communes_voisines[v][2]))
            }
            if (insee_commune_parente){
                $('#alerte_commune').empty();
                $('#alerte_commune').css('visibility','visible');
                $('#alerte_commune').append($('<div>').addClass('fermer-alerte').text('X'))
                $('#alerte_commune > .fermer-alerte').click(function(){
                    $('#alerte_commune').css('visibility','hidden');
                })
                $('#alerte_commune').append($('<p>').text(nom_commune+' est une ancienne commune. Elle a été incorporée dans ')
                                    .append($('<a>').addClass('lien_commune')
                                                    .attr('href',window.location.href.split('?')[0]+'?insee='+insee_commune_parente)
                                                    .text(nom_commune_parente+' ('+insee_commune_parente+')')))
            }
            rendu_bano(code_insee,nom_commune)
        })
        update_search('insee',$('#input_insee')[0].value)
*        $('body').css('cursor','default');
    };
    function update_csv_url(){
        urlCSV = 'requete_pifometre_voies.py?insee='+$('#input_insee')[0].value+'&format=csv';
    }
    function get_osm_state(){
        $.ajax({
            url: "osm_state.py",
            async:false
        })
        .done(function( data ){
            osm_state = data;
        })
    }
    function refresh_infobulle(){
        $('#refresh_infobulle').empty()
                            .append('Mettre à jour avec les données OSM du ')
                            .append($('<span>').append(osm_state+' (UTC)'))
                            .show()
    }
</script>
</head>

<body onload="start()">
    <header>
        <!--#include file="includes/menu.html" -->
    </header>

    <div id="barre-jaune">
        <span>Commune :</span>
        <form action="javascript:reset_url_hash();reset_panneau_map();requete_pifometre()" autocomplete="on">
            <input type="text" id="input_insee" placeholder="Code INSEE"></input>
            <input type="submit" value="Afficher la carte">
        </form>
    </div>

    <div id="bandeau">
        <div id="descriptif" class ="pifo"></div>
        <div id="refresh_infobulle"></div>
        <div id="table_communes_voisines">
            <div class="fermer">X</div>
            <table>
            <tbody>
                <tr><td id="11"></td><td id="12"></td><td id="1"></td><td id="2"></td></tr>
                <tr><td id="10"></td><td class="commune_centre" colspan="2" rowspan="2"></td><td id="3"></td></tr>
                <tr><td id="9"></td><td id="4"></td></tr>
                <tr><td id="8"></td><td id="7"></td><td id="6"></td><td id="5"></td></tr>
            </tbody>
            </table>
        </div>
        <div id="wait_ajax" class="pifomap"></div>

        <div id="bouton_progression">
            <p><input type="radio" id="radio_prog_noms" name="switch_noms_adresses" value="affiche_noms" >
            <label for="radio_prog_noms">Intégration des noms de voies</label></p>
            <p><input type="radio" id="radio_prog_adresses" name="switch_noms_adresses" value="affiche_adresses" >
            <label for="radio_prog_adresses">Intégration des adresses</label></p>
        </div>
        <button id="bouton_communes_voisines" title="Communes voisines"></button>
        <button id="bouton_refresh"></button>
        <div id="alerte_commune" class="pifomap"></div>
        <div id="infos_refresh"></div>
        <div id="bouton_legende"><p>Légende</p></div>
    </div>
    <div id="reponse" class="pifomap">
        <div id="panneau_map">
            <h2></h2> <!-- Nom commune -->
            <div id="contenu">
                <div id="infos_numero"></div>
                <div id="infos_voie_lieudit"></div>
                <table id="pifomap_table_liens"></table>
            </div>
        </div>
        <div id="map_div"></div>
    </div>

    <div id="legende" class="pifomap">
    <div class="fermer">X</div>
            <h3>Voies et lieux-dits affichés :</h3>
            <p><span class="rapproche">Verts</span> : issus d'OSM, rapprochés avec le fichier Topo (ex-Fantoir)</p>
            <p><span class="non_rapproche">Rouges</span> : issus du cadastre (pour les lieux-dits) ou de la BAN (pour les voies) avec un nom inconnu d'OSM</p>
            <p><span class="osm_seulement">Bleus</span> : connus seulement d'OSM</p>
            <h3>Voies au survol de la souris :</h3>
            <p><span class="voie_survolee verte">–</span> : toutes voies, places, adresses... portant le même nom que l'objet survolé</p>
            <p><span class="voie_survolee orange">–</span> : idem, mais dépassant des limites de la commune</p>
            <h3>Points d'adresses :</h3>
            <p><span class="point integre"></span> issus d'OSM et connus de la BAN</p>
            <p><span class="point non_integre"></span> issus de la BAN, non retrouvés dans OSM</p>
            <p><span class="point osm_seulement"></span> issus d'OSM, non retrouvés dans la BAN</p>
            <h3>Intégration des adresses et noms de voies :</h3>
            <table>
            <tr>
                <td><span class="point integration i0"></span></td>
                <td><span class="point integration i8"></span></td>
                <td><span class="point integration i16"></span></td>
                <td><span class="point integration i25"></span></td>
                <td><span class="point integration i33"></span></td>
                <td><span class="point integration i41"></span></td>
                <td><span class="point integration i50"></span></td>
                <td><span class="point integration i58"></span></td>
                <td><span class="point integration i66"></span></td>
                <td><span class="point integration i75"></span></td>
                <td><span class="point integration i83"></span></td>
                <td><span class="point integration i91"></span></td>
                <td><span class="point integration i100"></span></td>
            </tr>
            <tr>
                <td>0%</td>
                <td></td>
                <td></td>
                <td>25%</td>
                <td></td>
                <td></td>
                <td>50%</td>
                <td></td>
                <td></td>
                <td>75%</td>
                <td></td>
                <td></td>
                <td>100%</td>
            </tr>
            </table>
            <p><span class="petit">Ce rapport correspond à :<br/>- nombre de noms de voies présentes sur OSM / Nombre de noms de voies recensés dans le fichier Topo
                <br/>- nombre d'adresses présentes sur OSM / Nombre d'adresses recensées par la <abbr title="Base Adresses Nationale">BAN</abbr></span></p>
    </div>

    <footer>
    <!--#include file="includes/footer.html" -->
    </footer>
    <div id="josm_target" style="visibility : hidden"></div>
</body>
</html>