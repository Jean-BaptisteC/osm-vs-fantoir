<html>
<head>
<meta charset="UTF-8">
<title>Qualification des numéros d'adresses BAN</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/tablesorter/jquery.tablesorter.js"></script>
<script src="js/jquery.tablesorter.combined.min.js"></script>
<script src="js/fonctions.js"></script>
<link rel="preload" href="css/fonts/opensans-latin.woff2" as="font" type="font/woff2" crossorigin>
<link rel="stylesheet" href="css/bulma/bulma.min.css" type="text/css"/>
<link rel="stylesheet" href="css/bulma/main.min.css" type="text/css"/>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/responsive.css" type="text/css"/>
<!-- leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
<script>
    table = 'table_inspect_adresse'
    var menu_labels
    FILTRES = [["numero_ban",true],
               ["numero_osm",true],
               ["en_commun",true],
               ["ban_seulement",true],
               ["osm_seulement",true],
               ["pair",true],
               ["impair",true]
               ]
    function update_filtres(){
        for (let i = 0; i < FILTRES.length; i++){
            FILTRES[i] = [FILTRES[i][0],$('#check_'+FILTRES[i][0]).is(':checked')]
        }
    }
    function active_menu_filtres(){
        $('#boutons-filtres input').click(function(){
            show_mask_map_icon()
            update_menu_filtres()
        })
    };
    function update_menu_filtres(){
        $('#boutons-filtres li span.control-label').each(function(){
            total = $('#map .map_numero.'+$(this).attr('critere')).length
            visible = $('#map .map_numero:visible.'+$(this).attr('critere')).length
            if ($(this).attr('critere')=='en_commun') {
                total=total/2
                visible=visible/2
            }
            $(this).children('span').text(' ('+visible+' / '+total+')')
        })
    };
    function show_mask_map_icon(){
        update_filtres()
        $('.map_numero').each(function() {
            action = 'donotfilter'
            for (let f of FILTRES){
                if ($(this).hasClass(f[0]) && f[1] == false){
                    action = 'filter'
                }
            }
            if (action == 'filter'){
                $(this).css('display','none')
            } else {
                $(this).css('display','block')
            }
       });
    }
    function check_url_for_fantoir(){
        pattern_fantoir = new RegExp('^[0-9][0-9abAB][0-9]{3}[0-9|a-z|A-Z]{4}$')
        var res
        if (window.location.search){
            if (window.location.search.split('fantoir=')[1].split('&')[0]){
                if (pattern_fantoir.test(window.location.search.split('fantoir=')[1].split('&')[0])){
                    res = window.location.search.split('fantoir=')[1].split('&')[0]
                } else {
                    alert(window.location.search.split('fantoir=')[1].split('&')[0]+' n\'est pas un code FANTOIR valide\n\nAbandon')
                }
            }
        }
        return res
    }
    function check_url_for_source(){
        var res
        res = ""
        if (window.location.search){
            if (window.location.search.split('&source=')[1]){
                if (window.location.search.split('source=')[1].split('&')[0]){
                    res = window.location.search.split('source=')[1].split('&')[0]
                }
            }
        }
        return res
    }

    function add_josm_addr_link(insee,nom_commune,fantoir,nom_fantoir,nombre,fantoir_dans_relation,is_place){
        //Nb de points
        $('#liens_voie').append($('<span>').addClass('zone-clic-adresses')
                            .append($('<span>').text(nombre > 1 ? nombre+' Points':'1 Point'))
                        )
        if (is_place){
            $('#liens_voie .zone-clic-adresses').append($('<span>').text(' (lieu-dit)'))
        }
        //Ajouter lien
        $('#liens_voie .zone-clic-adresses').click(function(){
                                                stringToRemove = window.location.href.split('/').pop()
                                                srcURL = 'http://127.0.0.1:8111/import?changeset_tags='+get_changeset_tags_addr(insee,nom_commune)+'&new_layer=true&layer_name='+nom_fantoir+'&url='+window.location.href.replace(stringToRemove,'')+'requete_numeros.py?insee='+insee+'&fantoir='+fantoir+'&modele='+((is_place) ? 'Place':'Points');
                                                $('<img>').appendTo($('#josm_target')).attr('src',srcURL);
                                            })
        //Ou relation si c'est une voie
        if (!is_place){
            $('#liens_voie').append($('<span>').text(' ou '))
            $('#liens_voie').append($('<span>').addClass('zone-clic-adresses').text('Relation')
                                                .click(function(){
                                                    stringToRemove = window.location.href.split('/').pop()
                                                    srcURL = 'http://127.0.0.1:8111/import?changeset_tags='+get_changeset_tags_addr(insee,nom_commune)+'&new_layer=true&layer_name='+nom_fantoir+'&url='+window.location.href.replace(stringToRemove,'')+'requete_numeros.py?insee='+insee+'&fantoir='+fantoir+'&modele=Relation&fantoir_dans_relation='+fantoir_dans_relation;
                                                    $('<img>').appendTo($('#josm_target')).attr('src',srcURL);
                                                })
                                    )
        }
    }
    function add_statut_numero(id_ligne,numero,statut,insee,fantoir,ban_id){
        $('#'+table+' tr:last').removeClass().addClass('statut'+statut).attr('numero',numero).attr('statut',statut)
        $('#'+table+' tr:last').append($('<td>').append($(a_menus_labels[statut]).change(function() {
            statut = $(this)[0].value;
            $.ajax({
                url: "statut_numero.py?insee="+insee+"&fantoir="+fantoir+"&statut="+statut+"&numero="+numero+"&source=BAN"
            })
            .done(function( data ) {
                if(data == statut){
                    $('tr#'+id_ligne).removeClass().addClass('statut'+statut).attr('statut',statut);
                    update_url_mes_adresses_commentaire(id_ligne,ban_id)

                    //Afficher l'infobulle de confirmation
                    if (statut != '0') {
                        $('tr#'+id_ligne+' td:eq(1)').append($('<span class="enregistrement numeros rose">').text('✔ Enregistré'));
                    }
                    else {
                        $('tr#'+id_ligne+' td:eq(1)').append($('<span class="enregistrement numeros bleu">').text('✔ Enregistré'));
                    }
                    setTimeout(function(){
                        $('tr#'+id_ligne+' td:eq(1) span').css('opacity', '1');
                        setTimeout(function(){
                            $('tr#'+id_ligne+' td:eq(1) span').css('opacity', '0');                      
                        }, 1500);
                        setTimeout(function(){
                            $('tr#'+id_ligne+' td:eq(1) span').remove();                
                        }, 2000);
                    }, 50);

                } else {
                    alert("Souci lors de la mise à jour du statut. Le nouveau statut n'a pas été pris en compte")
                }
                refresh();
            })
        })))
    }
    function start(){
        $.ajax({
            url: "labels_statut_numero.py"
        })
        .done(function( data ) {
            a_menus_labels = []
            labels_statut = {}

            for (c=0;c<data.length;c++){
                labels_statut[data[c][0]] = data[c][1]
            }
            for (c=0;c<data.length;c++){
                menu_labels = '<select>'
                id_label = 0
                for (i=0;i<data.length;i++){
                    if (c!=i){
                        menu_labels+='<option value='+data[i][0]+'>'+data[i][1]+'</option>'
                    } else {
                        menu_labels+='<option value='+data[i][0]+' selected>'+data[i][1]+'</option>'
                        id_label = data[i][0]
                    }
                }
                menu_labels+='</select>'
                a_menus_labels[id_label] = menu_labels
            }
        })

        insee = check_url_for_insee()
        fantoir = check_url_for_fantoir()
        source = check_url_for_source()

        $.ajax({
            url: "requete_inspect_numeros.py?insee="+insee+"&fantoir="+fantoir
        })
        .done(function( data ) {
                                let[nom_fantoir,
                                    is_place,
                                    numeros_a_proposer,
                                    nom_commune,
                                    nom_voie,
                                    rapproche] = data[0]
                                data = data[1]
                                min_lon = data[0][1] == undefined ? data[0][4]:data[0][1];
                                max_lon = min_lon;
                                min_lat = data[0][2] == undefined ? data[0][5]:data[0][2];
                                max_lat = min_lat;

                                var map = L.map('map').setView([min_lat, min_lon], 18);
                                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom: 19}).addTo(map);

                                // INFOS 1e COLONNE : Liens commune, intégration adresses
                                $('#infos_commune_col1').empty()
                                                    /*.append($('<div id="date-maj">')
                                                      .append($('<div>').addClass('cellule_intitule').append('<strong>Code Insee :</strong>'))
                                                      .append($('<div>').addClass('cellule_data').append('&nbsp;').append(insee))
                                                    )*/
                                .append($('<div id="liens_commune">')
                                    .append('<strong>Code Insee :</strong>')
                                    .append('&nbsp;').append(insee+'. ')
                                                    
                                    .append('<strong>Voir la commune sur :</strong> ')
                                  /*.append($('<a>')
                                      .attr('target','blank')
                                      .attr('href',url_map_org_part1+'?mlat='+lat_commune+'&mlon='+lon_commune+'#map='+url_hash_coords)
                                      .text('ORG')
                                  )
                                  .append(' / ')*/
                                  .append($('<a>')
                                      .attr('target','blank')
                                      .attr('href','https://adresse.data.gouv.fr/base-adresse-nationale/'+insee)
                                      .text('BAN')
                                  )
                                  .append(' / ')
                                  .append($('<a>')
                                      .attr('target','blank')
                                      .attr('href','index.html?insee='+insee)
                                      .text('Pifomètre')
                                  )
                                )

                                .append($('<div id="liens_voie">').append('<strong>Intégrer les adresses :</strong> '))

                                // INFOS 2e COLONNE : Nom voie, type voie, commune
                                $('#infos_commune_col2 h2').empty().append(nom_commune)
                                $('#infos_commune_col2 h1').empty().append(nom_voie)
                                
                                if (is_place==true){
                                   $('#infos_commune_col2 h1').append(' (lieu-dit)')
                                } else {
                                   $('#infos_commune_col2 h1').append(' (voie)')
                                }

                                if (numeros_a_proposer > 0){
                                    add_josm_addr_link(insee,nom_commune,fantoir,nom_fantoir,numeros_a_proposer,true,is_place)
                                } else {
                                    $('#liens_voie').append($('<span>').addClass('adresses-integrees').text('✔'))
                                                        .append($('<span>').text(' Adresses intégrées'))
                                }
                                $('#'+table).empty() .append($('<thead>')
                                                                        .append($('<tr>')
                                                                            .append($('<th>').append('Numéro'))
                                                                            .append($('<th>').append("Statut de l'adresse BAN"))
                                                                            .append($('<th id="colonne_signaler" title="Signaler un problème dans la BAN">').append('Signaler'))
                                                                            .append($('<th>').append('Zoomer'))
                                                                        )
                                                                    )

                                $('#'+table).append($('<tbody>'))
                                for (l=0;l<data.length;l++){
                                    let[numero,
                                        lon_ban,
                                        lat_ban,
                                        statut,
                                        lon_osm,
                                        lat_osm,
                                        ban_id] = data[l]
                                    parite = Number.parseInt(numero) % 2 == 0 ? 'pair':'impair';

                                    $('#'+table+' tbody:last').append($('<tr>').attr('id',l))

                                    if (lon_ban != undefined && lon_osm != undefined){
                                        $('#'+table+' tr:last').append($('<td>')
                                                                        .append($('<span class="pastille-verte" title="Intégrée dans OSM">'))
                                                                        .append($('<span>').text(numero)));
                                    } else if (lon_ban != undefined){
                                        $('#'+table+' tr:last').append($('<td>')
                                                                        .append($('<span class="pastille-orange" title="Pas encore intégrée dans OSM">'))
                                                                        .append($('<span>').text(numero)));
                                    } else if (lon_osm != undefined){
                                        $('#'+table+' tr:last').append($('<td>')
                                                                        .append($('<span class="pastille-bleue" title="Trouvée dans OSM et inconnue de la BAN">'))
                                                                        .append($('<span>').text(numero)));
                                    }

                                    //---COLONNE STATUT---
                                    if (lon_ban != undefined){
                                        add_statut_numero(l,numero,statut,insee,fantoir,ban_id)
                                    } else {
                                        $('#'+table+' tr:last').addClass('statut_vide').append($('<td>'))
                                    }

                                    //---COLONNE REMONTÉE DES SIGNALEMENTS---
                                    if (lon_ban != undefined){
                                        json_args = JSON.stringify({"comment":labels_statut[statut]})
                                        $('#'+table+' tr:last').append($('<td class="remontee_edit_numero">')
                                                                    .append($('<a class="remontee_edit_numero" target="_blank" title="Signaler un problème dans la BAN : Numéro à modifier">')
                                                                    .attr('href', 'https://mes-signalements.mes-adresses.fr/#/'+ban_id+'?sourceId=e32cd3e1-b19d-4a49-9aee-31a7929a8ead&type=LOCATION_TO_UPDATE')
                                                                        .append($('<span class="remontee_edit_numero">')
                                                                        )
                                                                    )
                                                                    .append($('<a class="remontee_suppr_numero" target="_blank" title="Signaler un problème dans la BAN : Numéro à supprimer">')
                                                                        .append($('<span class="remontee_suppr_numero">')
                                                                        )
                                                                    )
                                                                )
                                        update_url_mes_adresses_commentaire(l,ban_id)
                                    }
                                    else {
                                        $('#'+table+' tr:last').append($('<td>'))
                                    }

                                    //---COLONNE ZOOMER---
                                    $('#'+table+' tr:last').append($('<td class="zoom">')
                                                            .click(function(){
                                                                map.setView([lat_ban == undefined ? lat_osm:lat_ban,lon_ban == undefined ? lon_osm:lon_ban],19)
                                                            })
                                                            )

                                    if (lon_ban != undefined && lon_osm!= undefined){
                                        var myIcon = L.divIcon({className: 'map_numero numero_ban en_commun ligne'+l+' '+parite,html:'<span>'+numero+'</span>'});
                                        L.marker([lat_ban, lon_ban],{icon: myIcon}).addTo(map)
                                        min_lon = Math.min(min_lon,lon_ban);
                                        max_lon = Math.max(max_lon,lon_ban);
                                        min_lat = Math.min(min_lat,lat_ban);
                                        max_lat = Math.max(max_lat,lat_ban);
                                        var myIcon = L.divIcon({className: 'map_numero numero_osm en_commun ligne'+l+' '+parite,html:'<span>'+numero+'</span>'});
                                        L.marker([lat_osm, lon_osm],{icon: myIcon}).addTo(map)
                                        min_lon = Math.min(min_lon,lon_osm);
                                        max_lon = Math.max(max_lon,lon_osm);
                                        min_lat = Math.min(min_lat,lat_osm);
                                        max_lat = Math.max(max_lat,lat_osm);
                                    } else  if (lon_ban != undefined){
                                        var myIcon = L.divIcon({className: 'map_numero numero_ban ban_seulement ligne'+l+' '+parite,html:'<span>'+numero+'</span>'});
                                        L.marker([lat_ban, lon_ban],{icon: myIcon}).addTo(map)
                                        min_lon = Math.min(min_lon,lon_ban);
                                        max_lon = Math.max(max_lon,lon_ban);
                                        min_lat = Math.min(min_lat,lat_ban);
                                        max_lat = Math.max(max_lat,lat_ban);
                                    } else if (lon_osm != undefined){
                                        var myIcon = L.divIcon({className: 'map_numero numero_osm osm_seulement ligne'+l+' '+parite,html:'<span>'+numero+'</span>'});
                                        L.marker([lat_osm, lon_osm],{icon: myIcon}).addTo(map)
                                        min_lon = Math.min(min_lon,lon_osm);
                                        max_lon = Math.max(max_lon,lon_osm);
                                        min_lat = Math.min(min_lat,lat_osm);
                                        max_lat = Math.max(max_lat,lat_osm);
                                    }

                                    $('#'+table+' tr:last').hover(function() {
                                        $('.map_numero.ligne'+$(this).attr('id')).append($('<div class="map_numero_hover"></div>'))
                                    },function() {
                                            $('.map_numero_hover').remove()
                                    });

                                }
                                $('#'+table).trigger("resetToLoadState");
                                
                                //Sticky headers : le tableau scrolle dans son contenant
                                $('#'+table).tablesorter({
                                    widthFixed : true,
                                    headerTemplate : '{content} {icon}', // Add icon for various themes
                                    widgets: [ 'stickyHeaders', 'filter' ],
                                    widgetOptions: {
                                      stickyHeaders_attachTo : '#reponse'
                                    },
                                    sortList: [[0,0]]
                                });

                                map.fitBounds([[min_lat,min_lon],[max_lat,max_lon]]);
                                active_menu_filtres()
                                update_menu_filtres()
                                refresh();
                            })
    }

    function update_url_mes_adresses_commentaire(num_ligne,ban_id){
        current_statut = $('#table_inspect_adresse tr#'+num_ligne).attr('statut')
        changesRequested = ''
        // transfert du statut comme commentaire si différent de 'Ok'
        if (current_statut != "0"){
            json_args = JSON.stringify({"comment":labels_statut[current_statut]})
            changesRequested = '&changesRequested='+json_args
        }
        $('#table_inspect_adresse tr#'+num_ligne+' a.remontee_suppr_numero').attr('href','https://mes-signalements.mes-adresses.fr/#/'+ban_id+'?sourceId=e32cd3e1-b19d-4a49-9aee-31a7929a8ead&type=LOCATION_TO_DELETE'+changesRequested)
    }

    function refresh(){
        $('.map_numero').removeClass('anomalie');
        for (i=1;i<a_menus_labels.length;i++){
            $('.statut'+i).each(function(){
                $('.map_numero.ligne'+$(this).attr('id')).addClass('anomalie')
            })
        }
    }
</script>
</head>

<body onload="start()">

    <header>
        <!--#include file="includes/menu.html" -->
    </header>

    <div id="bandeau" class="haut">
        <div id="descriptif" class="page_numeros">
            <div id="infos_commune_col1"></div>
            <div id="infos_commune_col2">
                <h2></h2>
                <h1></h1>
            </div>

        <div id="boutons-filtres" class="page_numeros">
            <p id="ligne-afficher">Afficher sur la carte :</p>
            <div class="ligne-boutons-filtres">
                <div>
                    <p>Source</p>
                    <ul>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_numero_osm" checked>
                            <span class="check is-dark"></span>
                            <span class="control-label" critere="numero_osm">Adresses OSM<span></span></span>
                        </li>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_numero_ban" checked>
                            <span class="check is-dark"></span>
                            <span class="control-label" critere="numero_ban">Adresses BAN<span></span></span>
                        </li>
                    </ul>
                </div>
                <div>
                    <ul>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_en_commun" checked>
                            <span class="check is-green"></span>
                            <span class="control-label" critere="en_commun">Adresses rapprochées BAN-OSM<span></span></span>
                        </li>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_ban_seulement" checked>
                            <span class="check is-orange"></span>
                            <span class="control-label" critere="ban_seulement">Adresses BAN non integrées<span></span></span>
                        </li>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_osm_seulement" checked>
                            <span class="check is-blue"></span>
                            <span class="control-label" critere="osm_seulement">Adresses OSM hors BAN<span></span></span>
                        </li>
                    </ul>
                </div>
                <div>
                    <ul>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_pair" checked>
                            <span class="check is-dark"></span>
                            <span class="control-label" critere="pair">Numéros pairs<span></span></span>
                        </li>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_impair" checked>
                            <span class="check is-dark"></span>
                            <span class="control-label" critere="impair">Numéros impairs<span></span></span>
                        </li>
                    </ul>
                </div>
            </div>
        </div> 

        </div>


        <div id="legende_map">
             <p><span class="legende_numero numero_osm">Rond</span> : Adresses venant d'OSM</p>
             <p><span class="legende_numero numero_ban">Carré</span> : Adresses venant de la BAN</p>
             <p><span class="legende_numero anomalie">Rose</span> : Adresses BAN avec anomalie identifiée</p>
             <p><span class="legende_numero en_commun">Vert</span> : ✔ Adresses rapprochées BAN-OSM</p>
             <p><span class="legende_numero ban_seulement">Orange</span> : Adresses de la BAN non intégrées sur OSM</p>
             <p><span class="legende_numero osm_seulement">Bleu</span> : Adresses trouvées sur OSM mais inconnues de la BAN</p>

         </div> 

    </div>

    <div id="reponse_et_map">
        <div id="reponse" class="page_numeros">
            <table id="table_inspect_adresse" class="avec_statuts"></table>
        </div>
        <div id="map"></div>
     </div>
     
    <footer>
        <!--#include file="includes/footer.html" -->
    </footer>
    <div id="josm_target" style="visibility : hidden"></div>
    </body>
</html>
